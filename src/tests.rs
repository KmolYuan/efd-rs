#![doc(hidden)]

/// Epsilon for curve difference.
pub const EPS: f64 = 2e-14;

#[test]
fn efd2d() {
    use crate::*;
    use alloc::vec::Vec;
    let efd = Efd2::from_curve(closed_lin(PATH)).unwrap();
    // Test starting point
    let path = PATH
        .iter()
        .cycle()
        .skip(0)
        .take(PATH.len())
        .copied()
        .collect::<Vec<_>>();
    let efd_half = Efd2::from_curve(closed_lin(path)).unwrap();
    assert!(efd.l1_norm(&efd_half) < EPS);
    // Test transformation
    let trans = efd.as_trans();
    assert!((trans.trans()[0] - -1.248409055632365).abs() < f64::EPSILON);
    assert!((trans.trans()[1] - 55.26080122817753).abs() < f64::EPSILON);
    assert!((trans.rot().angle() - 0.6423416350347734).abs() < f64::EPSILON);
    assert!((trans.scale() - 48.16765830752243).abs() < f64::EPSILON);
    assert_eq!(efd.harmonic(), 6);
    // Test normalized
    let norm = efd.generate_norm(NORM.len());
    assert!(curve_diff(&norm, NORM) < EPS);
    // Test reconstruction
    let target = efd.generate(TARGET.len());
    assert!(curve_diff(&target, TARGET) < EPS);
}

#[test]
fn efd3d() {
    use crate::*;
    use alloc::vec::Vec;
    let efd = Efd3::from_curve(closed_lin(PATH3D)).unwrap();
    // Test starting point
    let path = PATH3D
        .iter()
        .cycle()
        .skip(PATH3D.len() / 2)
        .take(PATH3D.len())
        .copied()
        .collect::<Vec<_>>();
    let efd_half = Efd3::from_curve(closed_lin(path)).unwrap();
    assert!(efd.l1_norm(&efd_half) < EPS);
    // Test transformation
    let trans = efd.as_trans();
    assert!((trans.trans()[0] - 0.7239345388499508).abs() < f64::EPSILON);
    assert!((trans.trans()[1] - 0.09100107896533066).abs() < f64::EPSILON);
    assert!((trans.trans()[2] - 0.49979194975846675).abs() < f64::EPSILON);
    assert!((trans.rot()[0] - 0.9632980654768742).abs() < f64::EPSILON);
    assert!((trans.rot()[1] - -0.11462599352101828).abs() < f64::EPSILON);
    assert!((trans.rot()[2] - -0.20143638985563356).abs() < f64::EPSILON);
    assert!((trans.rot()[3] - 0.135429315510935).abs() < f64::EPSILON);
    assert!((trans.scale() - 0.5629099155595344).abs() < f64::EPSILON);
    assert_eq!(efd.harmonic(), 5);
    // Test normalized
    let norm = efd.generate_norm(NORM3D.len());
    assert!(curve_diff(&norm, NORM3D) < EPS);
    // Test reconstruction
    let target = efd.generate(NORM3D.len());
    assert!(curve_diff(&target, TARGET3D) < EPS);
}

#[test]
#[cfg(feature = "std")]
fn plot() -> Result<(), Box<dyn std::error::Error>> {
    use crate::*;
    use ndarray::*;
    use plotters::prelude::*;

    #[inline]
    fn font() -> TextStyle<'static> {
        ("Times New Roman", 24).into_font().color(&BLACK)
    }

    let efd = Efd2::from_curve(closed_lin(PATH)).unwrap();
    let b = SVGBackend::new("test.svg", (1200, 1200));
    let root = b.into_drawing_area();
    root.fill(&WHITE)?;
    let mut chart = ChartBuilder::on(&root)
        .set_label_area_size(LabelAreaPosition::Left, (8).percent())
        .set_label_area_size(LabelAreaPosition::Bottom, (4).percent())
        .margin((8).percent())
        .build_cartesian_2d(-60f64..60., -20f64..100.)?;
    chart
        .configure_mesh()
        .x_label_style(font())
        .y_label_style(font())
        .draw()?;
    let path = efd.generate(360);
    let p0 = path[0];
    chart.draw_series([Circle::new((p0[0], p0[1]), 3, BLACK.filled())])?;
    chart
        .draw_series(LineSeries::new(
            path.into_iter().map(|[x, y]| (x, y)),
            BLACK.stroke_width(3),
        ))?
        .label("Original")
        .legend(move |(x, y)| PathElement::new(vec![(x, y), (x + 20, y)], BLACK.stroke_width(3)));
    let trans0 = efd.as_trans();
    let mut c0 = [0.; 2];
    for (i, c) in efd.coeffs().axis_iter(Axis(0)).enumerate() {
        let color = Palette99::pick(i);
        let m = na::matrix![c[0], c[1]; c[2], c[3]];
        let f = |t: f64| {
            let v = m * na::matrix![t.cos(); t.sin()];
            [v[0], v[1]]
        };
        let t = Array1::linspace(0., std::f64::consts::TAU, 100);
        let trans = trans0 * Transform2::new(c0, na::UnitComplex::new(0.), 1.);
        let ellipse = t.into_iter().map(f).map(|[x, y]| {
            let [x, y] = trans.transform_pt(&[x, y]);
            (x, y)
        });
        let p1 = c0;
        c0[0] += c[0];
        c0[1] += c[2];
        let p2 = c0;
        let [x1, y1] = trans0.transform_pt(&p1);
        let [x2, y2] = trans0.transform_pt(&p2);
        chart.draw_series([Circle::new((x2, y2), 3, color.filled())])?;
        chart.draw_series(LineSeries::new([(x1, y1), (x2, y2)], &color))?;
        chart
            .draw_series(LineSeries::new(ellipse, color.stroke_width(3)))?
            .label(&format!("n={}", i + 1))
            .legend(move |(x, y)| {
                PathElement::new(vec![(x, y), (x + 20, y)], color.stroke_width(3))
            });
    }
    chart
        .configure_series_labels()
        .position(SeriesLabelPosition::LowerRight)
        .background_style(WHITE)
        .border_style(BLACK)
        .label_font(font())
        .draw()?;
    Ok(())
}

pub const PATH: &[[f64; 2]] = &[
    [14.928108089437242, 90.01002059789568],
    [-3.25371009238094, 85.46456605244113],
    [-16.763462931659024, 76.52439024390245],
    [-39.6173464560173, 57.055475143350215],
    [-49.46583130450215, 35.085778173653246],
    [-27.739072687756586, 14.939024390243903],
    [-2.117346456017304, 19.17668726456234],
    [17.958411119740273, 37.7372933251684],
    [26.291744453073605, 57.81305090092597],
    [43.71598687731603, 68.41911150698658],
    [47.12507778640693, 80.5403236281987],
    [38.41295657428572, 90.38880847668355],
    [27.80689596822512, 91.1463842342593],
];
pub const NORM: &[[f64; 2]] = &[
    [1.119379152671337, -0.05553234647386943],
    [0.9910207666952372, 0.19246492442111932],
    [0.7433455516363754, 0.3466236207064233],
    [0.4912450590109462, 0.4662127118631491],
    [0.21253057838553358, 0.5404258318025645],
    [-0.08088496699201134, 0.5402447537989888],
    [-0.35699414927505113, 0.5234770691714837],
    [-0.6467599401741159, 0.483330568432713],
    [-0.9080511096122624, 0.3595326487685509],
    [-1.0284506874180428, 0.14947774345139578],
    [-0.9974323951564845, -0.12263773651284177],
    [-0.8623052545037516, -0.3764679704172556],
    [-0.6347643368252188, -0.5140999552626939],
    [-0.35164920002427524, -0.5670235417766133],
    [-0.06800914369245911, -0.5674017234826676],
    [0.19828936299781613, -0.45931628321452417],
    [0.4527171824458201, -0.3348867313490356],
    [0.7264030988252986, -0.32487721086570215],
    [1.0003704310053017, -0.27954637306118696],
    [1.1193791526713373, -0.0555323464738718],
];
pub const TARGET: &[[f64; 2]] = &[
    [43.52580541936114, 85.41974003908122],
    [31.41914569934586, 91.2805058483037],
    [17.418517196895017, 90.07914804660189],
    [4.244753253462857, 87.41682783854023],
    [-8.646084287386033, 82.23649438254617],
    [-19.957195505252518, 73.7627420984368],
    [-30.122220256970994, 65.14867465329937],
    [-40.13933107431942, 55.23886845955356],
    [-46.64440712361967, 42.92448766942674],
    [-45.226608554249765, 31.348934230012294],
    [-36.17817108831738, 21.749151088169825],
    [-23.642141300790406, 15.858740317938057],
    [-10.894937602526898, 17.11650068817552],
    [1.5512941624695515, 23.24490544911555],
    [12.501526069295421, 31.415007924947],
    [19.653120825390836, 43.267887138455805],
    [25.87526755420776, 55.40858035781829],
    [36.1418456145505, 63.692076052934084],
    [45.40004894143899, 73.34595105201664],
    [43.52580541936122, 85.41974003908112],
];
#[rustfmt::skip]
pub const PATH_OPEN: &[[f64; 2]] = &[
    [0.028607755880487345, 47.07692307692308],
    [6.182453909726641, 52.76923076923077],
    [14.797838525111256, 57.07692307692308],
    [24.643992371265103, 58.61538461538461],
    [41.10553083280357, 59.07692307692308],
    [50.18245390972664, 56.76923076923077],
    [60.6439923712651, 51.53846153846154],
    [65.41322314049587, 46.0],
    [68.79783852511126, 36.92307692307692],
    [67.41322314049587, 25.384615384615383],
    [60.6439923712651, 18.153846153846153],
];
#[rustfmt::skip]
pub const PATH3D: &[[f64; 3]] = &[
    [0.6999100262927096,0.43028119112952473,0.5700737247541725],
    [0.6296590344074013,0.4512760872295425,0.6323601770225047],
    [0.5638138739696974,0.46183051089148464,0.6847090584540213],
    [0.5058369206546075,0.4615280764519245,0.7287803814245077],
    [0.45702863707701546,0.4510622388540364,0.7665948614304103],
    [0.41723197726966244,0.4317766784472379,0.799678921250722],
    [0.3856541747672426,0.40523683682222406,0.8288871838597307],
    [0.3614034251971859,0.3729768425814701,0.8545617819407205],
    [0.3437381466626122,0.33639334903869056,0.8767460300745514],
    [0.3321447389761846,0.29671906154191235,0.8953422088163436],
    [0.3263372629749841,0.25502826620566654,0.9102002934684913],
    [0.32622858809088523,0.21225076122841705,0.9211539082423659],
    [0.3318929803861661,0.16918542545203516,0.928021196624841],
    [0.34352480290022414,0.1265118028240236,0.9305834049340109],
    [0.36139084538662236,0.08480105307198857,0.9285501808026447],
    [0.38577056486989364,0.04452862638492877,0.9215195454857344],
    [0.41687739559371884,0.0060909757379047635,0.9089423177834546],
    [0.45475516434546037,-0.030172412132808968,0.8901052556002697],
    [0.49914754370187137,-0.06395289690096129,0.8641537806399759],
    [0.5493470560271839,-0.09494849409160033,0.8301822664355119],
    [0.6040449685807827,-0.1228552958162816,0.7874238072487618],
    [0.6612249903953387,-0.14739768525858138,0.7355647044666407],
    [0.7181712990997067,-0.1684251622294386,0.6751762361616609],
    [0.7716940290779204,-0.18608109658863914,0.6081629312757029],
    [0.8186957920221034,-0.20095221972437277,0.5379176568148215],
    [0.8570911228971989,-0.21393997152327254,0.46864111603170266],
    [0.88661962597743,-0.2256744734813517,0.403703691896119],
    [0.9087058112647335,-0.2359493070484034,0.3443568978212587],
    [0.9253987983439792,-0.24384980367577586,0.29012813939844717],
    [0.9384640530551117,-0.24830445184260166,0.24006274246229356],
    [0.9491216566898215,-0.2484529388271337,0.19349216519158882],
    [0.9581400770939057,-0.2437369857356437,0.1501994489037393],
    [0.9659871776934699,-0.2338686278496317,0.11033692690815355],
    [0.9729414021915203,-0.21877677851516128,0.07430847249221559],
    [0.979158591144934,-0.1985626427303512,0.04267704651223003],
    [0.984708076435491,-0.17346680001041803,0.0161019718314504],
    [0.9895891445905367,-0.1438444290548901,-0.004701610196814504],
    [0.9937341248474196,-0.11014503640716575,-0.01898841932855333],
    [0.997000753888979,-0.07289400668205587,-0.02599924103976281],
    [0.9991540450179144,-0.03267407497300495,-0.024971967263275538],
    [0.9998362404365794,0.009894685600921771,-0.015152145277328999],
    [0.9985225360959517,0.05417737861443478,0.004190054292864898],
    [0.9944609178696164,0.09954962956012486,0.03372468064136638],
    [0.9865989401537969,0.14542428454053347,0.07398857177482451],
    [0.9735136458469561,0.19127348741773503,0.12524230260109778],
    [0.9533914378420906,0.2366305939786505,0.18721839718014333],
    [0.9241589851285424,0.2810406966408692,0.25873982499375203],
    [0.8839235581077262,0.32391579444519214,0.33727985639690555],
    [0.8318395864591331,0.36427712952733915,0.4187422540212782],
    [0.7691918202384619,0.4004903064827955,0.49794724428553494],
];
#[rustfmt::skip]
pub const NORM3D: &[[f64; 3]] = &[
    [-0.9743604635265741, 0.05494822189879787, -0.41052840805469165],
    [-0.952392524599403, 0.1662586784407389, -0.411121688869958],
    [-0.905595234467908, 0.2679658717404657, -0.40677258020469764],
    [-0.8376986033179259, 0.354561230125791, -0.39815218591037277],
    [-0.7535020508676925, 0.4233136704987078, -0.38604437277172804],
    [-0.6579911690153166, 0.4742712135044105, -0.3709128892997494],
    [-0.5555870711786985, 0.509508851844636, -0.3526236452659972],
    [-0.4497095213478779, 0.5319707536299862, -0.33045078587673965],
    [-0.34271114538188907, 0.544371119879138, -0.30336564286629447],
    [-0.23610814349412876, 0.5485488385249881, -0.2704765374432522],
    [-0.13094266351947623, 0.5454491655413446, -0.2314131496774641],
    [-0.028094807821415255, 0.5356243558563683, -0.18646699802871772],
    [0.07158036905816006, 0.5199207951491469, -0.13640578211466112],
    [0.16731178204329614, 0.4999451656156719, -0.08203148440268596],
    [0.258583912787179, 0.47800760888911337, -0.023685535415084415],
    [0.34527799171922746, 0.45648261244655747, 0.039041449448891714],
    [0.4276494671203244, 0.4368080385753543, 0.10719343892450486],
    [0.5060836330529772, 0.41854178386691393, 0.18187602681366144],
    [0.5806798152848612, 0.3989267575461364, 0.2633695387107038],
    [0.6508097420000193, 0.37325712483744, 0.3502295992451993],
    [0.7148354649699137, 0.33604701406609055, 0.4387334049838145],
    [0.7701361412740614, 0.2826877230516492, 0.5229535034568691],
    [0.8134914230048438, 0.21106435168926807, 0.5955496570843745],
    [0.8417394714404213, 0.12257561759237778, 0.6491271338976503],
    [0.8525196511541574, 0.022178598310058046, 0.6778029310394744],
    [0.8448666450603006, -0.08259794615176001, 0.6785270385585686],
    [0.8194628065136235, -0.1833791269282826, 0.6517622384950865],
    [0.7784659518785734, -0.27286808410550967, 0.6013175034587762],
    [0.7249703868244518, -0.34637227242904883, 0.5333920833940392],
    [0.6622780246522959, -0.40248893433133137, 0.4551293133511664],
    [0.5932106319344681, -0.4428097442604033, 0.3731177801644656],
    [0.5196652067484513, -0.47084190356474814, 0.2922671504235312],
    [0.44251580349447134, -0.49058967924874847, 0.2153349631482884],
    [0.3618364862359121, -0.5053096076807433, 0.1431472225178535],
    [0.2773115205934359, -0.51682796257504, 0.07532535402529561],
    [0.18865092273473202, -0.5255492934981826, 0.011185936529259866],
    [0.09585733343678453, -0.5309986991114012, -0.04953586539115301],
    [-0.0007216831817576028, -0.5325428637315478, -0.10637682250790363],
    [-0.10051297081884865, -0.5299009846754937, -0.15829995172667022],
    [-0.20288342168863713, -0.5231930478084151, -0.2041743964427224],
    [-0.3072061388398576, -0.5125160553171464, -0.24332603968617197],
    [-0.4127319102551153, -0.4972823577950949, -0.275898777690602],
    [-0.5182713787459774, -0.4756927415423158, -0.30286679403365485],
    [-0.6218011028318657, -0.4446891290129703, -0.32569722275703017],
    [-0.7201745093514254, -0.40054575844123425, -0.34581241283077013],
    [-0.8091142532993414, -0.33998788960386456, -0.36408082096216293],
    [-0.8835819834618946, -0.2614841106922872, -0.3805457731743953],
    [-0.9384920959525473, -0.16624434356482254, -0.39449434915756],
    [-0.9696057380514115, -0.05852262705075104, -0.40482235510860437],
    [-0.9743604635265739, 0.05494822189880164, -0.4105284080546917],
];
#[rustfmt::skip]
pub const TARGET3D: &[[f64; 3]] = &[
    [0.32609587255870043, 0.2626914373285255, 0.9089784150350606],
    [0.3268547667440557, 0.2006447789107254, 0.9240999186073894],
    [0.3398215882907302, 0.13921695337641185, 0.9301168120003069],
    [0.3637961809992804, 0.08197292623730663, 0.9271597557272415],
    [0.39680771345482674, 0.031192039732756076, 0.9161104760767289],
    [0.43645616610909616, -0.01232208858649042, 0.8982095707207425],
    [0.4802943599000913, -0.048994779530759286, 0.8746377125118077],
    [0.5261572576225173, -0.07993658214616023, 0.8462307169734731],
    [0.5723660708442766, -0.10633878128718932, 0.8134198004416184],
    [0.6177765102934463, -0.1290440690228071, 0.7763847861045775],
    [0.6616891173038449, -0.1484342433534878, 0.7353146371821315],
    [0.7036787858103951, -0.1646289257531412, 0.6906264666721025],
    [0.7434178119499643, -0.177849205668205, 0.6430196609146271],
    [0.780557606565413, -0.18872607857971385, 0.5933251851639376],
    [0.8147034829972577, -0.1983568827156778, 0.5422155458468796],
    [0.8454769292789076, -0.20802515969636387, 0.48992179466411356],
    [0.8726254006970922, -0.21865513085192767, 0.4361227387946469],
    [0.8961230152799462, -0.23020697257087502, 0.3801155010610441],
    [0.9162116004938502, -0.24127568849119485, 0.3212643019638336],
    [0.9333567302768732, -0.24910710630401478, 0.25959917009704875],
    [0.9481272520815593, -0.25010367169471404, 0.19634963612958195],
    [0.9610362229234867, -0.24071164320979943, 0.13418919119778105],
    [0.9723953945363863, -0.21842896948297813, 0.07704447398810205],
    [0.9822299014492795, -0.18260940627856298, 0.029464817187614845],
    [0.9902777027149166, -0.134790574665085, -0.004297039299638206],
    [0.9960687066541616, -0.07842533372765628, -0.02123103126954462],
    [0.9990526836145024, -0.01809289840317313, -0.020256355420060213],
    [0.9987321492897538, 0.04156292871826528, -0.0024367536760497854],
    [0.994759957150851, 0.09683792878889043, 0.029338650699324176],
    [0.9869784488585697, 0.14561684000773917, 0.07110149689947359],
    [0.9753998836909388, 0.18750536173332832, 0.1187377590389131],
    [0.9601472913478506, 0.2234658807610645, 0.16882185533106503],
    [0.9413840245778821, 0.25514169716326196, 0.21911657103881638],
    [0.9192572216118706, 0.28413920490123334, 0.2686338929430592],
    [0.8938685026522837, 0.31151641448656264, 0.317309565348475],
    [0.8652712777036212, 0.3376142785219678, 0.3654713084481941],
    [0.8334849071157906, 0.36221390475414134, 0.41333219854869513],
    [0.7985154498844352, 0.3848713635892616, 0.4607018320065073],
    [0.760379937021587, 0.40522433842879696, 0.5069986129860544],
    [0.719140886729536, 0.4231012749415605, 0.5515129973616152],
    [0.6749633061383077, 0.43837466827130955, 0.5937674698044937],
    [0.6282025727551652, 0.4506357991854506, 0.6337844947493076],
    [0.5795177009932198, 0.4588690161895701, 0.6721198201085565],
    [0.5299852545716668, 0.46132493955124143, 0.7096239651598779],
    [0.4811730376437313, 0.4557224802116117, 0.7470149031767032],
    [0.43512852728222756, 0.43977619791959494, 0.7844303253213716],
    [0.39425005422900167, 0.41190248889172887, 0.8211438664657181],
    [0.361037852249039, 0.37186497854665507, 0.8555702392493594],
    [0.3377593287053868, 0.3211169401722231, 0.8855738080822104],
    [0.32609587255870026, 0.2626914373285234, 0.9089784150350613],
];
